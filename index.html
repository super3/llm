<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebLLM Chat Interface</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 6v6l4 2'/%3E%3C/svg%3E">
    <script type="module">
        import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";
        window.CreateMLCEngine = CreateMLCEngine;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #0d0d0d;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Chat List Sidebar */
        .chat-sidebar {
            width: 260px;
            background: #171717;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2a2a2a;
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .chat-sidebar.collapsed {
            width: 68px;
        }

        .chat-sidebar.collapsed .chat-sidebar-header,
        .chat-sidebar.collapsed .chats-section-header,
        .chat-sidebar.collapsed .chat-list {
            display: none;
        }

        .chat-sidebar.collapsed .new-chat-icon-only {
            display: flex;
        }

        .chat-sidebar.collapsed .collapse-btn {
            display: none;
        }

        .new-chat-icon-only {
            display: none;
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 0 auto;
        }

        .new-chat-icon-only:hover {
            background: #2a2a2a;
        }

        .sidebar-nav {
            padding: 0 8px 16px 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .chat-sidebar.collapsed .sidebar-nav {
            display: none;
        }

        .nav-item {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #999;
            font-size: 14px;
            user-select: none;
        }

        .nav-item:hover {
            background: #2a2a2a;
            color: #fff;
        }

        .nav-item.active {
            background: #2a2a2a;
            color: #fff;
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .sidebar-top {
            padding: 12px 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .chat-sidebar.collapsed .sidebar-top {
            padding: 12px 14px;
            align-items: center;
            flex-direction: column;
            gap: 12px;
        }

        .logo-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-btn:hover {
            background: #2a2a2a;
        }

        .chat-sidebar.collapsed .logo-btn {
            margin: 0 auto;
            position: relative;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            transition: opacity 0.2s ease;
        }

        .logo-btn .collapse-icon {
            display: none;
            width: 18px;
            height: 18px;
        }

        .chat-sidebar.collapsed .logo-btn:hover .logo-icon {
            display: none;
        }

        .chat-sidebar.collapsed .logo-btn:hover .collapse-icon {
            display: block;
        }

        .collapse-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .collapse-btn:hover {
            background: #2a2a2a;
            color: #fff;
        }


        .chat-sidebar-header {
            padding: 8px 8px 4px 8px;
        }

        .new-chat-btn {
            width: 100%;
            height: 40px;
            padding: 0 12px;
            background: transparent;
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
        }

        .new-chat-btn:hover {
            background: #2a2a2a;
        }

        .new-chat-btn::before {
            content: '‚úè';
            font-size: 18px;
            font-weight: 300;
        }

        .chats-section-header {
            padding: 16px 20px 8px 20px;
            font-size: 12px;
            font-weight: 500;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            user-select: none;
        }

        .chats-section-header:hover {
            color: #888;
        }

        .chats-section-header:hover .chats-caret {
            color: #888;
        }

        .chats-caret {
            font-size: 14px;
            transition: transform 0.2s ease, opacity 0.2s ease;
            color: #666;
            transform: rotate(90deg);
            opacity: 0;
        }

        .chats-section-header:hover .chats-caret {
            opacity: 1;
        }

        .chats-section-header.collapsed .chats-caret {
            transform: rotate(0deg);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px 8px 8px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .chat-list.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding: 0 8px;
        }

        .chat-item {
            padding: 8px 12px;
            margin-bottom: 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .chat-item:hover {
            background: #2a2a2a;
        }

        .chat-item.active {
            background: #2a2a2a;
        }

        .chat-item-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-delete {
            opacity: 0;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 20px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            line-height: 1;
            font-weight: 300;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            background: #3a3a3a;
            color: #ddd;
        }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d0d0d;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 32px 24px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        .message {
            margin-bottom: 32px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #2a2a2a;
        }

        .message.assistant .message-avatar {
            background: #2a2a2a;
        }

        .message-role {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
        }

        .message-content {
            color: #d1d1d1;
            line-height: 1.7;
            font-size: 15px;
            padding-left: 44px;
        }

        .message-content strong {
            color: #fff;
            font-weight: 600;
        }

        /* Input Area */
        .input-area {
            padding: 16px 24px 24px;
            background: #0d0d0d;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .input-area.hidden {
            display: none;
        }

        /* Empty state centered input */
        .empty-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 0 24px;
        }

        .empty-state.visible {
            display: flex;
        }

        .empty-state-headline {
            font-size: 32px;
            font-weight: 400;
            color: #fff;
            margin-bottom: 40px;
        }

        .empty-state-input-wrapper {
            max-width: 800px;
            width: 100%;
            background: #2a2a2a;
            border: none;
            border-radius: 28px;
            display: flex;
            align-items: center;
            padding: 14px 24px;
            transition: background 0.2s ease;
        }

        .empty-state-input-wrapper:focus-within {
            background: #333;
        }

        .empty-state-input {
            flex: 1;
            padding: 8px 0;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            outline: none;
        }

        .empty-state-input::placeholder {
            color: #777;
        }

        .empty-state-send-btn {
            background: transparent;
            border: none;
            color: #999;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .empty-state-send-btn:hover {
            background: #3a3a3a;
            color: #fff;
        }

        .empty-state-send-btn:disabled {
            color: #555;
            cursor: not-allowed;
        }

        .model-selector-wrapper {
            position: relative;
            align-self: flex-start;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            width: 100%;
        }

        .input-wrapper {
            background: #2a2a2a;
            border: none;
            border-radius: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            transition: background 0.2s ease;
        }

        .input-wrapper:focus-within {
            background: #333;
        }

        .input-tools {
            display: none;
        }

        .input-box {
            flex: 1;
            padding: 8px 0;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            max-height: 200px;
        }

        .input-box::placeholder {
            color: #777;
        }

        .send-btn {
            background: transparent;
            border: none;
            color: #999;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #3a3a3a;
            color: #fff;
        }

        .send-btn:disabled {
            color: #555;
            cursor: not-allowed;
        }

        .input-footer {
            display: none;
        }

        /* Scrollbar Styling */
        .chat-list::-webkit-scrollbar,
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-list::-webkit-scrollbar-track,
        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list::-webkit-scrollbar-thumb,
        .messages-container::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 10px;
        }

        .chat-list::-webkit-scrollbar-thumb:hover,
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        /* Status Bar */
        .status-bar {
            padding: 12px 24px;
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            font-size: 13px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-indicator.loading {
            background: #f59e0b;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-indicator.ready {
            background: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .typing-indicator {
            display: none;
            padding-left: 44px;
            color: #666;
            font-size: 14px;
            margin-top: -16px;
            margin-bottom: 16px;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-indicator::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Marketplace View */
        .marketplace-view {
            display: none;
            flex-direction: column;
            flex: 1;
            background: #0d0d0d;
            overflow-y: auto;
        }

        .marketplace-view.active {
            display: flex;
        }

        .marketplace-view::-webkit-scrollbar {
            width: 6px;
        }

        .marketplace-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .marketplace-view::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 10px;
        }

        .marketplace-view::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        .marketplace-hero {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 40px 60px;
            text-align: center;
        }

        .marketplace-hero h1 {
            font-size: 56px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #fff;
            background: linear-gradient(135deg, #fff 0%, #999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .marketplace-hero p {
            font-size: 20px;
            color: #b0b0b0;
            max-width: 700px;
            margin: 0 auto 40px;
            line-height: 1.7;
        }

        .marketplace-cta {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
        }

        .btn-primary {
            background: #fff;
            color: #0a0a0a;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: #fff;
            padding: 14px 32px;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: #666;
            transform: translateY(-2px);
        }

        .marketplace-stats {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        .marketplace-stats h2 {
            font-size: 32px;
            margin-bottom: 40px;
            text-align: center;
            color: #fff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
        }

        @media (max-width: 1000px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: #141414;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 28px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: #444;
            transform: translateY(-4px);
        }

        .stat-label {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fff;
        }

        .stat-description {
            font-size: 14px;
            color: #b0b0b0;
        }

        .marketplace-nodes {
            max-width: 1200px;
            margin: 60px auto;
            padding: 0 40px 40px;
        }

        .marketplace-nodes h2 {
            font-size: 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .node-list {
            background: #141414;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
        }

        .node-header {
            display: grid;
            grid-template-columns: 1fr 180px 160px 140px 120px;
            padding: 16px 24px;
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .node-item {
            display: grid;
            grid-template-columns: 1fr 180px 160px 140px 120px;
            padding: 20px 24px;
            border-bottom: 1px solid #2a2a2a;
            transition: background 0.2s;
            align-items: center;
            font-size: 14px;
        }

        .node-item:last-child {
            border-bottom: none;
        }

        .node-item:hover {
            background: #1a1a1a;
        }

        .node-id {
            font-family: 'Monaco', 'Courier New', monospace;
            color: #b0b0b0;
        }

        .node-model {
            color: #fff;
        }

        .node-performance {
            color: #6fbf6f;
            font-weight: 600;
        }

        .node-location {
            color: #888;
        }

        .node-status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #1a3a1a;
            border: 1px solid #2a5a2a;
            border-radius: 10px;
            font-size: 11px;
            color: #6fbf6f;
            font-weight: 600;
        }

        .marketplace-how {
            max-width: 1200px;
            margin: 60px auto;
            padding: 0 40px 60px;
        }

        .marketplace-how h2 {
            font-size: 32px;
            text-align: center;
            margin-bottom: 60px;
            color: #fff;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
        }

        @media (max-width: 900px) {
            .steps-grid {
                grid-template-columns: 1fr;
            }
        }

        .step {
            text-align: center;
        }

        .step-number {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #333 0%, #1a1a1a 100%);
            border: 2px solid #444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
        }

        .step h3 {
            font-size: 20px;
            margin-bottom: 12px;
            color: #fff;
        }

        .step p {
            color: #b0b0b0;
            font-size: 15px;
            line-height: 1.7;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
        }

        .modal-content h3 {
            font-size: 22px;
            margin-bottom: 14px;
            color: #fff;
        }

        .modal-content p {
            color: #b0b0b0;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #initStatus {
            margin-top: 14px;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            font-size: 13px;
            color: #888;
            display: none;
        }

        #initStatus.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Chat List Sidebar -->
        <aside class="chat-sidebar" id="chatSidebar">
            <div class="sidebar-top">
                <button class="logo-btn" id="toggleSidebarBtn" title="Toggle sidebar">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <svg class="collapse-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <line x1="9" y1="3" x2="9" y2="21"/>
                    </svg>
                </button>
                <button class="collapse-btn" id="collapseSidebarBtn" title="Close sidebar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <line x1="9" y1="3" x2="9" y2="21"/>
                    </svg>
                </button>
                <button class="new-chat-icon-only" id="newChatIconBtn" title="New chat">‚úè</button>
            </div>
            <div class="chat-sidebar-header">
                <button class="new-chat-btn" id="newChatBtn">New chat</button>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item" id="navNetwork">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <circle cx="19" cy="5" r="2"/>
                        <circle cx="5" cy="19" r="2"/>
                        <circle cx="19" cy="19" r="2"/>
                        <path d="M14 12l5-7M10 12l-5 7M14 12l5 7"/>
                    </svg>
                    <span class="nav-item-text">Network</span>
                </div>
            </div>
            <div class="chats-section-header" id="chatsSectionHeader">
                <span>Chats</span>
                <span class="chats-caret">‚Ä∫</span>
            </div>
            <div class="chat-list" id="chatList">
                <!-- Chats will be dynamically added here -->
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-area">
            <div class="status-bar">
                <div class="status-indicator"></div>
                <span class="status-text">Initializing...</span>
            </div>

            <!-- Empty state for new chats -->
            <div class="empty-state" id="emptyState">
                <div class="empty-state-headline">Ready when you are.</div>
                <div class="empty-state-input-wrapper">
                    <input type="text" class="empty-state-input" id="emptyStateInput" placeholder="Ask anything" />
                    <button class="empty-state-send-btn" id="emptyStateSendBtn">‚û§</button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be dynamically added here -->
            </div>
            <div class="typing-indicator" id="typingIndicator">Assistant is typing</div>

            <div class="input-area" id="inputArea">
                <div class="input-container">
                    <div class="input-wrapper">
                        <div class="input-tools">
                            <button class="input-tool-btn" title="Attach file">üìé</button>
                            <button class="input-tool-btn" title="More options">‚ñº</button>
                        </div>
                        <textarea
                            class="input-box"
                            rows="1"
                            placeholder="Ask anything"
                        ></textarea>
                        <button class="send-btn">‚û§</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Marketplace View -->
        <main class="marketplace-view" id="marketplaceView">
            <section class="marketplace-hero">
                <h1>Earn Credits. Run AI.</h1>
                <p>
                    Share your GPU power to earn credits, then spend them accessing models beyond your hardware capabilities.
                    A decentralized marketplace for browser-based LLM inference.
                </p>
                <div class="marketplace-cta">
                    <button class="btn-primary" id="joinNetworkBtn">Join Network</button>
                    <button class="btn-secondary" id="learnMoreBtn">Learn More</button>
                </div>
            </section>

            <section class="marketplace-stats">
                <h2>Network Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Active Nodes</div>
                        <div class="stat-value" id="activeNodes">1,247</div>
                        <div class="stat-description">Contributing compute</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Compute</div>
                        <div class="stat-value" id="totalCompute">3.2 TF/s</div>
                        <div class="stat-description">Available power</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Requests Today</div>
                        <div class="stat-value" id="requestsToday">45.2K</div>
                        <div class="stat-description">Served requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Models Hosted</div>
                        <div class="stat-value" id="modelsHosted">12</div>
                        <div class="stat-description">Available models</div>
                    </div>
                </div>
            </section>

            <section class="marketplace-nodes">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <circle cx="19" cy="5" r="2"/>
                        <circle cx="5" cy="19" r="2"/>
                        <circle cx="19" cy="19" r="2"/>
                        <path d="M14 12l5-7M10 12l-5 7M14 12l5 7"/>
                    </svg>
                    Available Compute Nodes
                </h2>
                <div class="node-list">
                    <div class="node-header">
                        <div>Node ID</div>
                        <div>Model</div>
                        <div>Performance</div>
                        <div>Location</div>
                        <div>Status</div>
                    </div>
                    <div id="nodeListContainer">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </section>

            <section class="marketplace-how">
                <h2>How It Works</h2>
                <div class="steps-grid">
                    <div class="step">
                        <div class="step-number">1</div>
                        <h3>Join Network</h3>
                        <p>Open your browser and join the compute network. Your GPU power becomes available to the marketplace.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <h3>Earn Credits</h3>
                        <p>Process inference requests and run benchmarks to earn credits based on compute provided.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <h3>Access Models</h3>
                        <p>Spend credits to run powerful models you couldn't run locally, powered by the network.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Join Network Modal -->
    <div class="modal" id="joinModal">
        <div class="modal-content">
            <h3>Join Compute Network</h3>
            <p>This will initialize WebGPU and benchmark your device to determine compute capabilities. Your browser will begin contributing to the network.</p>
            <div id="initStatus"></div>
            <div class="modal-buttons">
                <button class="btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn-primary" id="confirmJoinBtn">Start Contributing</button>
            </div>
        </div>
    </div>

    <script type="module">
        // WebLLM Integration
        let engine = null;
        const MODEL = "Phi-3-mini-4k-instruct-q4f16_1-MLC-1k";

        // Chat Management
        let chats = {};
        let activeChat = null;

        // DOM Elements
        const textarea = document.querySelector('.input-box');
        const sendBtn = document.querySelector('.send-btn');
        const messagesContainer = document.getElementById('messagesContainer');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.status-text');
        const chatList = document.getElementById('chatList');
        const newChatBtn = document.getElementById('newChatBtn');
        const emptyState = document.getElementById('emptyState');
        const emptyStateInput = document.getElementById('emptyStateInput');
        const emptyStateSendBtn = document.getElementById('emptyStateSendBtn');
        const inputArea = document.getElementById('inputArea');

        // Chat Management Functions
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateChatTitle(firstMessage) {
            if (!firstMessage) return 'New Chat';
            const words = firstMessage.split(' ').slice(0, 5);
            return words.join(' ') + (firstMessage.split(' ').length > 5 ? '...' : '');
        }

        function createNewChat() {
            const chatId = generateChatId();
            chats[chatId] = {
                id: chatId,
                title: 'New Chat',
                messages: [],
                createdAt: Date.now()
            };
            saveChats();
            switchToChat(chatId);
            renderChatList();
            return chatId;
        }

        function switchToChat(chatId) {
            activeChat = chatId;
            localStorage.setItem('activeChat', chatId);
            renderMessages();
            renderChatList();
        }

        function deleteChat(chatId) {
            if (Object.keys(chats).length <= 1) {
                return; // Don't delete the last chat
            }
            delete chats[chatId];
            saveChats();

            if (activeChat === chatId) {
                // Switch to another chat
                const chatIds = Object.keys(chats);
                if (chatIds.length > 0) {
                    switchToChat(chatIds[0]);
                } else {
                    createNewChat();
                }
            }
            renderChatList();
        }

        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        function loadChats() {
            const saved = localStorage.getItem('chats');
            if (saved) {
                chats = JSON.parse(saved);
            }

            // If no chats exist, create one
            if (Object.keys(chats).length === 0) {
                createNewChat();
            } else {
                // Load the last active chat
                const lastActive = localStorage.getItem('activeChat');
                if (lastActive && chats[lastActive]) {
                    activeChat = lastActive;
                } else {
                    activeChat = Object.keys(chats)[0];
                }
            }
        }

        function renderChatList() {
            chatList.innerHTML = '';
            const sortedChats = Object.values(chats).sort((a, b) => b.createdAt - a.createdAt);

            sortedChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item' + (chat.id === activeChat ? ' active' : '');

                const titleSpan = document.createElement('span');
                titleSpan.className = 'chat-item-title';
                titleSpan.textContent = chat.title;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'chat-item-delete';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.title = 'Delete chat';

                // Switch to chat when clicking the title
                titleSpan.addEventListener('click', () => {
                    switchToChat(chat.id);
                    if (currentView === 'network') {
                        showChatView();
                    }
                });

                // Delete chat when clicking delete button
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Delete this chat?')) {
                        deleteChat(chat.id);
                    }
                });

                chatItem.appendChild(titleSpan);
                chatItem.appendChild(deleteBtn);
                chatList.appendChild(chatItem);
            });
        }

        function renderMessages() {
            if (!activeChat || !chats[activeChat]) return;

            const chat = chats[activeChat];
            messagesContainer.innerHTML = '';

            if (chat.messages.length === 0) {
                // Show empty state
                emptyState.classList.add('visible');
                messagesContainer.style.display = 'none';
                inputArea.classList.add('hidden');
            } else {
                // Show messages
                emptyState.classList.remove('visible');
                messagesContainer.style.display = 'block';
                inputArea.classList.remove('hidden');

                chat.messages.forEach(msg => {
                    addMessageToUI(msg.role, msg.content);
                });
            }
        }

        // Initialize WebLLM Engine
        async function initEngine() {
            try {
                statusIndicator.classList.add('loading');
                statusText.textContent = 'Loading model (this may take a few minutes)...';

                engine = await window.CreateMLCEngine(MODEL, {
                    initProgressCallback: (progress) => {
                        console.log(progress);
                        statusText.textContent = progress.text || 'Loading model...';
                    }
                });

                statusIndicator.classList.remove('loading');
                statusIndicator.classList.add('ready');
                statusText.textContent = `${MODEL} ready! Chat is 100% local and private.`;
                textarea.disabled = false;
                sendBtn.disabled = false;
                emptyStateInput.disabled = false;
                emptyStateSendBtn.disabled = false;

                console.log('WebLLM engine initialized successfully');
            } catch (error) {
                console.error('Failed to initialize engine:', error);
                statusIndicator.classList.remove('loading');
                statusText.textContent = 'Failed to load model. Check console for details.';
            }
        }

        // Add message to UI only
        function addMessageToUI(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
                    <div class="message-role">${role === 'user' ? 'You' : 'Assistant'}</div>
                </div>
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add message to chat and UI
        function addMessage(role, content) {
            if (!activeChat || !chats[activeChat]) return;

            // Add to chat history
            chats[activeChat].messages.push({ role, content });

            // Update title if this is the first user message
            if (role === 'user' && chats[activeChat].messages.length === 1) {
                chats[activeChat].title = generateChatTitle(content);
                renderChatList();
            }

            // Save to localStorage
            saveChats();

            // Add to UI
            addMessageToUI(role, content);
        }

        // Send message and get response
        async function sendMessage() {
            const userMessage = textarea.value.trim();
            if (!userMessage || !engine || !activeChat) return;

            // If in empty state, switch to normal view
            if (emptyState.classList.contains('visible')) {
                emptyState.classList.remove('visible');
                messagesContainer.style.display = 'block';
                inputArea.classList.remove('hidden');
            }

            // Disable input while processing
            textarea.disabled = true;
            sendBtn.disabled = true;
            emptyStateInput.disabled = true;
            emptyStateSendBtn.disabled = true;

            // Add user message
            addMessage('user', userMessage);

            // Clear input
            textarea.value = '';
            textarea.style.height = 'auto';

            // Show typing indicator
            typingIndicator.classList.add('active');

            try {
                // Get all messages for this chat
                const chatMessages = chats[activeChat].messages;

                // Get response from WebLLM
                const reply = await engine.chat.completions.create({
                    messages: chatMessages,
                    temperature: 0.7,
                    max_tokens: 1024,
                });

                const assistantMessage = reply.choices[0].message.content;

                // Add assistant message
                addMessage('assistant', assistantMessage);

            } catch (error) {
                console.error('Error generating response:', error);
                addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            } finally {
                // Hide typing indicator and re-enable input
                typingIndicator.classList.remove('active');
                textarea.disabled = false;
                sendBtn.disabled = false;
                emptyStateInput.disabled = false;
                emptyStateSendBtn.disabled = false;
                textarea.focus();
            }
        }

        // Auto-resize textarea
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Handle Enter key (send) vs Shift+Enter (new line)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Send button click handler
        sendBtn.addEventListener('click', sendMessage);

        // Empty state input handlers
        emptyStateInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = emptyStateInput.value.trim();
                if (message && engine && activeChat) {
                    // Copy message to main input and send
                    textarea.value = message;
                    emptyStateInput.value = '';
                    sendMessage();
                }
            }
        });

        emptyStateSendBtn.addEventListener('click', () => {
            const message = emptyStateInput.value.trim();
            if (message && engine && activeChat) {
                // Copy message to main input and send
                textarea.value = message;
                emptyStateInput.value = '';
                sendMessage();
            }
        });

        // New chat button
        newChatBtn.addEventListener('click', () => {
            createNewChat();
            if (currentView === 'network') {
                showChatView();
            }
        });

        // Sidebar collapse/expand
        const chatSidebar = document.getElementById('chatSidebar');
        const collapseSidebarBtn = document.getElementById('collapseSidebarBtn');
        const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
        const newChatIconBtn = document.getElementById('newChatIconBtn');

        // Collapse sidebar
        collapseSidebarBtn.addEventListener('click', () => {
            chatSidebar.classList.add('collapsed');
        });

        // Toggle sidebar when clicking logo (only when collapsed, or switch to chat when in network)
        toggleSidebarBtn.addEventListener('click', () => {
            if (chatSidebar.classList.contains('collapsed')) {
                chatSidebar.classList.remove('collapsed');
            } else if (currentView === 'network') {
                showChatView();
            }
        });

        // New chat from icon button (when collapsed)
        newChatIconBtn.addEventListener('click', () => {
            createNewChat();
            if (currentView === 'network') {
                showChatView();
            }
        });

        // Chats section collapse/expand
        const chatsSectionHeader = document.getElementById('chatsSectionHeader');
        chatsSectionHeader.addEventListener('click', () => {
            chatsSectionHeader.classList.toggle('collapsed');
            chatList.classList.toggle('collapsed');
        });

        // Disable input until model loads
        textarea.disabled = true;
        sendBtn.disabled = true;
        emptyStateInput.disabled = true;
        emptyStateSendBtn.disabled = true;

        // Initialize on page load
        loadChats();
        renderChatList();
        renderMessages();
        initEngine();

        // ==================== MARKETPLACE VIEW ====================

        // View Management
        const chatArea = document.querySelector('.chat-area');
        const marketplaceView = document.getElementById('marketplaceView');
        const navNetwork = document.getElementById('navNetwork');
        const chatSidebarHeader = document.querySelector('.chat-sidebar-header');
        const chatsSectionHeaderEl = document.getElementById('chatsSectionHeader');
        const chatListEl = document.getElementById('chatList');
        const sidebarNav = document.querySelector('.sidebar-nav');

        let currentView = 'chat'; // 'chat' or 'network'

        function showChatView() {
            currentView = 'chat';
            chatArea.style.display = 'flex';
            marketplaceView.classList.remove('active');
            navNetwork.classList.remove('active');
            // Re-render chat list to restore active chat highlighting
            renderChatList();
        }

        function showNetworkView() {
            currentView = 'network';
            chatArea.style.display = 'none';
            marketplaceView.classList.add('active');
            navNetwork.classList.add('active');
            // Remove active class from all chat items
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            renderNodes();
        }

        navNetwork.addEventListener('click', showNetworkView);

        // Mock node data
        const mockNodes = [
            { id: 'node-a3f7', model: 'Phi-3-mini', performance: '42 tok/s', location: 'US-West', status: 'online' },
            { id: 'node-b8e2', model: 'Llama-3-8B', performance: '38 tok/s', location: 'EU-Central', status: 'online' },
            { id: 'node-c1d9', model: 'Phi-3-mini', performance: '51 tok/s', location: 'US-East', status: 'online' },
            { id: 'node-d4k6', model: 'Mistral-7B', performance: '35 tok/s', location: 'Asia-Pacific', status: 'online' },
            { id: 'node-e7m3', model: 'Phi-3-mini', performance: '45 tok/s', location: 'EU-West', status: 'online' },
            { id: 'node-f2n8', model: 'Llama-3-8B', performance: '40 tok/s', location: 'US-Central', status: 'online' },
            { id: 'node-g9p1', model: 'Gemma-2B', performance: '68 tok/s', location: 'US-West', status: 'online' },
            { id: 'node-h5q4', model: 'Phi-3-mini', performance: '47 tok/s', location: 'EU-North', status: 'online' },
        ];

        // Populate node list
        function renderNodes() {
            const container = document.getElementById('nodeListContainer');
            container.innerHTML = mockNodes.map(node => `
                <div class="node-item">
                    <div class="node-id">${node.id}</div>
                    <div class="node-model">${node.model}</div>
                    <div class="node-performance">${node.performance}</div>
                    <div class="node-location">${node.location}</div>
                    <div><span class="node-status-badge">${node.status}</span></div>
                </div>
            `).join('');
        }

        // Animate stats on view load
        function animateStats() {
            const stats = [
                { id: 'activeNodes', start: 800, end: 1247, duration: 2000 },
                { id: 'requestsToday', start: 30, end: 45.2, duration: 2000, suffix: 'K' }
            ];

            stats.forEach(stat => {
                const element = document.getElementById(stat.id);
                if (!element) return;

                const range = stat.end - stat.start;
                const increment = range / (stat.duration / 16);
                let current = stat.start;

                const timer = setInterval(() => {
                    current += increment;
                    if (current >= stat.end) {
                        current = stat.end;
                        clearInterval(timer);
                    }

                    if (stat.suffix) {
                        element.textContent = current.toFixed(1) + stat.suffix;
                    } else {
                        element.textContent = Math.floor(current).toLocaleString();
                    }
                }, 16);
            });
        }

        // Modal handlers
        const joinModal = document.getElementById('joinModal');
        const joinBtn = document.getElementById('joinNetworkBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmJoinBtn');
        const initStatus = document.getElementById('initStatus');
        const learnMoreBtn = document.getElementById('learnMoreBtn');

        if (joinBtn) {
            joinBtn.addEventListener('click', () => {
                joinModal.classList.add('active');
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                joinModal.classList.remove('active');
                initStatus.classList.remove('active');
                initStatus.textContent = '';
            });
        }

        if (confirmBtn) {
            confirmBtn.addEventListener('click', async () => {
                initStatus.classList.add('active');
                initStatus.textContent = 'Checking WebGPU availability...';

                // Simulate initialization
                await new Promise(resolve => setTimeout(resolve, 1000));

                if (!navigator.gpu) {
                    initStatus.textContent = '‚ö†Ô∏è WebGPU not available in this browser. Please use Chrome 113+ or Safari.';
                    return;
                }

                initStatus.textContent = '‚úì WebGPU available. Initializing compute engine...';
                await new Promise(resolve => setTimeout(resolve, 1500));

                initStatus.textContent = '‚úì Running benchmarks...';
                await new Promise(resolve => setTimeout(resolve, 2000));

                initStatus.textContent = '‚úì Successfully joined network! Switching to chat...';
                await new Promise(resolve => setTimeout(resolve, 1000));

                joinModal.classList.remove('active');
                initStatus.classList.remove('active');
                initStatus.textContent = '';
                showChatView();
            });
        }

        if (learnMoreBtn) {
            learnMoreBtn.addEventListener('click', () => {
                document.querySelector('.marketplace-how').scrollIntoView({ behavior: 'smooth' });
            });
        }

        // Simulate live updates
        setInterval(() => {
            if (currentView === 'network') {
                const activeNodesEl = document.getElementById('activeNodes');
                if (activeNodesEl) {
                    const current = parseInt(activeNodesEl.textContent.replace(/,/g, ''));
                    const change = Math.floor(Math.random() * 10) - 5;
                    activeNodesEl.textContent = Math.max(1000, current + change).toLocaleString();
                }
            }
        }, 5000);
    </script>
</body>
</html>
